@inject NavigationManager navigation
<tr class="mail-item @(mail.isDraft ? "drafts" : "") @(isRead ? "read" : "unread") @(isChecked ? "is-selected" : "" )" style="gap: 0 10px">
    <td class="mail-td mail-checkbox">
        @if (isChecked)
            {
                <span class="icon is-small" @onclick="SelectedMail">
                    <i class="material-icons-sharp is-secondary-60">check_box</i>
                </span>  
            }
        else
            {
                <span class="icon is-small" @onclick="SelectedMail">
                    <i class="material-icons-outlined is-secondary-60">check_box_outline_blank</i>
                </span>
            }
    </td>
    <td class="mail-td mail-Important">
        @if (isImportant)
            { 
                <span class="icon is-small is-warning-20" @onclick="() => Important(false)">
                    <i class="material-icons-sharp" style="font-size: 12px;">star_purple500</i>
                </span>
            }
        else
            { 
                <span class="icon is-small is-warning-20" @onclick="() => Important(true)">
                    <i class="material-symbols-outlined "  style="font-size: 12px;">star</i>
                </span>
            }
    </td>
    <td class="mail-td mail-from">
        <span class="is_sub2 @(isRead ? "read" : "unread") text-ellipsis">
            @if(isSentMail) 
            {
                <span class="mr-1">Đến: </span>
            }
            @foreach (var item in @mail.to.Take(1))
            {
                @item.name;
            }
            <span class="ml-1">...</span>
        </span>
    </td>
    <td class="mail-td mail-main" @onclick="HandleViewDetail">
        <div>
            <div class="mail-main-content" style="gap: 0 10px">
                <div class="is-flex is-align-items-center" style="gap: 0 5px">

                    @foreach (var item in mail.tags)
                    {
                        <div style="background-color: @item.backgroundColor ;" class="mailtag-item">
                            <span style="color: @item.textColor ;">
                               @item.name
                            </span>
                        </div>
                    }
                </div>
                <div class="mail-subject">
                    <span class="text-ellipsis is_sub2 @(isRead ? "read" : "unread")">
                        @mail.subject
                    </span>
                </div>
                <span class="mx-1 is_body2 @(isRead ? "read" : "unread")">
                    -
                </span>
                <div class="mail-body">
                    @mail.shortBody
                </div>
            </div>    
        </div>
        @if(mail.attachments.Count > 0)
        {
            <ul class="attachments-list">
                @foreach (var attachment in mail.attachments.Take(3))
                    {
                        <li class="attachment-item">
                            <img style="width: 16px; height: 16px;" src="@string.Concat("images/", attachment.icon, ".png")">
                            <span>@attachment.name</span>
                        </li>
                    }
            @if (mail.attachments.Count() > 2)
                {
                    <li class="attachment-item count">
                        <span class="is_sub2 is-secondary-40">+@(mail.attachments.Count() - 3)</span>
                    </li>
                 }
        </ul>
        }
    </td>
    <td class="mail-td">
        <div class="mail-actions is-align-content-center">
            @if (isRead)
                {
                    <span class="icon is-pointer is-small" @onclick="() => Read(false)">
                        <i class="material-icons-outlined"> drafts</i>
                    </span>
                }
            else
            { 
                <span class="icon is-pointer is-small" @onclick="() => Read(true)">
                    <i class="material-icons-outlined">mail</i>
                </span>
            }
                <span class="icon is-pointer is-small" @onclick="() => Trash()">
                    <i class="material-icons-outlined">delete</i>
                </span>
        </div>
    </td>
    <td class="mail-td tags-list">
        @foreach (var label in labels.Take(2))
            {
                <div style="background-color: @(label.color + "33")" class="tag-item">
                    <span style="color: @label.color;" class="is_caption">@label.name</span>
                </div>
            }
            @if (labels.Count() > 2)
            {
                <div class="tag-item count">
                        <span class="is_sub2 is-secondary-40">+@(labels.Count() - 2)</span>
                </div>
            }

    </td>
    <td class="mail-td mail__item-datetime">
        <span class="is-block @(isRead ? "read" : "unread")">@sentDate</span>
    </td>
</tr>
@code {

    [Parameter] public bool isSentMail { get; set; }
    [Parameter] public MailModel mail  { get; set; } = new ();
    [Parameter] public bool isChecked { get; set; }
    [Parameter] public EventCallback<SelectedModel> HandleSelectedMail { get; set; }
    [Parameter] public EventCallback<MailModel> HandleTrashItem { get; set; }

    public bool isImportant { get; set; }
    public bool isRead { get; set; }
    public string sentDate { get; set; }
    public List<LabelModel> labels = new List<LabelModel>();

    protected override async Task OnInitializedAsync()
    {
        isImportant  = mail.isImportant;
        isRead = mail.isRead;
        sentDate = DateTimeHelper.FormatDateTime(mail.sentDate);
        labels = await LabelData.FindLabelsByIds(mail.labels);
    }


    private async Task SelectedMail()
    {
        var selected = new SelectedModel
            {
                isChecked = !isChecked,
                itemId = mail.id,
            };
        await HandleSelectedMail.InvokeAsync(selected);
    }


    private async Task Important(bool isImportantMail)
    {
        isImportant = isImportantMail;
        await MailData.Important(mail.id, isImportant);
    }


    private async Task Read(bool isReadMail)
    {
        isRead = isReadMail;
        await MailData.Read(mail.id, isRead);
    }

    private void HandleViewDetail() 
    {
        if(!mail.isDraft)
        {
            navigation.NavigateTo("inbox/" + mail.id, true);
        }
        else
        {
            navigation.NavigateTo($"create?mailId={mail.id}");
        }
        
    }

    private void Trash()
    {
        HandleTrashItem.InvokeAsync(mail);
    }   

}